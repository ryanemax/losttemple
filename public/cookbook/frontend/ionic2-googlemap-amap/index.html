<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="description" content="Arch, Nova, Association, Science, The ship of information era.-Anas IT Inc.|刘雨飏,安纳斯联盟创始人,全栈工程师,CIO,Ryane">
<meta name="keywords" content="ionic2,frontend,amap,高德地图,angular2|刘雨飏,安纳斯联盟创始人,全栈工程师,CIO,Ryane">
<meta name="author" content="刘雨飏, the Founder of ANAS">
<meta name="generator" content="Hugo 0.16-DEV" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://ryanemax.github.io/css/style.css" type="text/css">
<link rel="alternate" href="https://ryanemax.github.io/index.xml" type="application/rss+xml" title="刘雨飏@ANAS联盟">
<title>ionic2及ng2谷歌/高德地图控件分析实例 - 刘雨飏@ANAS联盟</title>

<link rel="stylesheet" href="https://ryanemax.github.io//css/code/monokai.css">
<script src="https://ryanemax.github.io//js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script type="text/javascript" charset="utf-8">
var getElementsByClass = function(searchClass,node,tag) {
	var classElements = new Array();
	if ( node == null )
		node = document;
	if ( tag == null )
		tag = '*';
	var els = node.getElementsByTagName(tag);
	var elsLen = els.length;
	var pattern = new RegExp("(^|\\s)"+searchClass+"(\\s|$)");
	for (i = 0, j = 0; i < elsLen; i++) {
		if ( pattern.test(els[i].className) ) {
			classElements[j] = els[i];
			j++;
		}
	}
	return classElements;
}
window.onload=function(){
	var obj1=document.getElementById("blink1");	
	var obj2=document.getElementById("blink2");	
	var timer=null;
		var i1=0;
		var i2=0;
		clearInterval(timer);

		timer=setInterval(function(){
			obj1.innerHTML=i1++%2?"&nbsp;":"_";
			obj2.innerHTML=i2++%2?"&nbsp;":"_";
			false&&clearInterval(timer);
		},700);
};
</script>

</head>
<body>

	<div class="container" style="margin-right:28px;margin-top:4px;float:right;text-align:right;">
		
		<a href="https://github.com/ryanemax"><img src="https://ryanemax.github.io//images/github2-dreamstale35.png"></a>
		
		
		
		<a href="https://twitter.com/ryanemax"><img src="https://ryanemax.github.io//images/twitter-dreamstale71.png"></a>
		
		
		
		<a href="https://www.linkedin.com/in/ryanemax"><img src="https://ryanemax.github.io//images/linkedin-dreamstale45.png"></a>
		
		<a href="https://ryanemax.github.io//index.xml"><img src="https://ryanemax.github.io//images/feed-dreamstale27.png"></a>
	</div>
<header>
  <div class="container">
    <a class="path" href="https://ryanemax.github.io/">[刘雨飏@ANAS联盟]</a>
		<span class="caret"># <span id="blink1">_</span></span>
  </div>

</header>


<div class="container">


<main role="main" class="article">
  
<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2016-03-30">March 30, 2016</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="https://ryanemax.github.io/categories/cookbook/frontend">cookbook/frontend</a>

    </span>


    <br>
    <span class="key">tags:</span>
    <span class="val">

        <a href="https://ryanemax.github.io/tags/ionic2">ionic2</a>

        <a href="https://ryanemax.github.io/tags/frontend">frontend</a>

        <a href="https://ryanemax.github.io/tags/amap">amap</a>

    </span>

  </div>
  <h1 class="headline" itemprop="headline">ionic2及ng2谷歌/高德地图控件分析实例</h1>
  <section class="body" itemprop="articleBody">
    

<h1 id="ionic2及ng2谷歌-高德地图控件分析实例:f65739047e30db9a825e1a5bb607abf7">《ionic2及ng2谷歌/高德地图控件分析实例》</h1>

<h1 id="创建示例项目:f65739047e30db9a825e1a5bb607abf7">创建示例项目</h1>

<p>项目地址：<a href="https://github.com/driftyco/ionic-conference-app">https://github.com/driftyco/ionic-conference-app</a></p>

<pre><code class="language-sh">git clone https://github.com/driftyco/ionic-conference-app
cd ionic-conference-app
npm install
ionic serve
</code></pre>

<h1 id="map-js解析:f65739047e30db9a825e1a5bb607abf7">map.js解析</h1>

<h2 id="问题:f65739047e30db9a825e1a5bb607abf7">问题</h2>

<ul>
<li>google.maps.Map包来自哪里，如何实现的？</li>
<li>如何将map.js迁移至高德地图，以便国内用户使用？</li>
</ul>

<h2 id="代码展示:f65739047e30db9a825e1a5bb607abf7">代码展示</h2>

<pre><code class="language-js">// 文件 project/app/pages/map/map.js
onPageLoaded() {
  this.confData.getMap().then(mapData =&gt; {
    let mapEle = document.getElementById('map');

    let map = new google.maps.Map(mapEle, {
      center: mapData.find(d =&gt; d.center),
      zoom: 16
    });

    mapData.forEach(markerData =&gt; {
      let infoWindow = new google.maps.InfoWindow({
        content: `&lt;h5&gt;${markerData.name}&lt;/h5&gt;`
      });

      let marker = new google.maps.Marker({
        position: markerData,
        map: map,
        title: markerData.name
      });

      marker.addListener('click', () =&gt; {
        infoWindow.open(map, marker);
      });
    });

    google.maps.event.addListenerOnce(map, 'idle', () =&gt; {
      mapEle.classList.add('show-map');
    });

  });
}
</code></pre>

<h2 id="探索:f65739047e30db9a825e1a5bb607abf7">探索</h2>

<h3 id="寻找google地图插件:f65739047e30db9a825e1a5bb607abf7">寻找google地图插件</h3>

<ol>
<li>查找整个项目，但发现不存在任何googlet地图包引入相关的代码</li>
</ol>

<pre><code class="language-sh">  cd project/app
  grep -rn &quot;map&quot;
</code></pre>

<ol>
<li><p>查找看webpack.config.js，不存在任何google地图包引入</p></li>

<li><p>是否angular2中自带google地图包</p>

<ul>
<li>参考：<a href="https://angular.io/docs/js/latest">https://angular.io/docs/js/latest</a></li>
<li>不存在</li>
</ul></li>

<li><p>是否ionic2自带google地图包</p>

<ul>
<li>参考：<a href="http://ionicframework.com/docs/v2/">http://ionicframework.com/docs/v2/</a></li>
<li>不存在</li>
</ul></li>

<li><p>index.html中引入了googlemaps的api</p></li>
</ol>

<pre><code class="language-html">  &lt;!-- google maps script is loaded last as to not block rendering --&gt;
  &lt;script src=&quot;//maps.googleapis.com/maps/api/js?sensor=false&quot;&gt;&lt;/script&gt;
</code></pre>

<p>注释掉script引入，测试是否影响程序运行，报错</p>

<pre><code class="language-js">  EXCEPTION: ReferenceError: google is not defined app.bundle.js:34204
  EXCEPTION: ReferenceError: google is not defined
</code></pre>

<p>注释后报错，确认google地图插件来自于index页面script的引入</p>

<h2 id="实践-更换地图控件为高德地图:f65739047e30db9a825e1a5bb607abf7">实践——更换地图控件为高德地图</h2>

<ul>
<li>参考地址：<a href="http://lbs.amap.com/api/javascript-api/guide/quickstart/">http://lbs.amap.com/api/javascript-api/guide/quickstart/</a></li>

<li><p>key申请：注册成为高德开发者，申请appkey</p></li>

<li><p>在index.html添加高德api引入代码</p></li>
</ul>

<pre><code class="language-html">  &lt;script type=&quot;text/javascript&quot; src=&quot;http://webapi.amap.com/maps?v=1.3&amp;key=您申请的key值&quot;&gt;&lt;/script&gt;
</code></pre>

<ol>
<li>参考高德快速入门，重写map.js的OnPageLoaded部分代码</li>
</ol>

<pre><code class="language-js">  onPageLoaded() {
  this.confData.getMap().then(mapData =&gt; {
    let mapEle = document.getElementById('map');

    let map = new AMap.Map('map', {
      center: mapData.find(d =&gt; d.center),
      zoom: 16
    });
</code></pre>

<p>报错</p>

<pre><code class="language-js">  EXCEPTION: TypeError: this.ib(...) is undefined
</code></pre>

<p>原因：mapData.find()函数中经纬度格式不正确</p>

<ol>
<li>修改正确的OnPageLoaded代码</li>
</ol>

<pre><code class="language-js">  let mapEle = document.getElementById('map');

  let cdata = mapData.find(d =&gt; d.center);

  let map = new AMap.Map(mapEle, {
   center: [cdata.lng,cdata.lat],
   zoom: 16
  });

</code></pre>

<p>报错，但不影响使用</p>

<pre><code class="language-js">  Firefox can t establish a connection to the server at ws://vdata.amap.com/. maps:1:28148

  The connection to ws://vdata.amap.com/ was interrupted while the page was loading.
</code></pre>

<ol>
<li>Console不报错但是无法显示？CSS样式问题！</li>
</ol>

<p>注释掉两行调整透明度的样式即可成功</p>

<pre><code class="language-css">  .map-page #map {
  width: 100%;
  height: 100%;
  //opacity: 0;
  //transition: opacity 150ms ease-in
  }
</code></pre>

<ol>
<li>继续修复marker和info控件</li>
</ol>

<h2 id="实践成果-附上完美整合高德地图后map-js的onpageloaded-函数:f65739047e30db9a825e1a5bb607abf7">实践成果——附上完美整合高德地图后map.js的OnPageLoaded()函数</h2>

<pre><code class="language-js">onPageLoaded() {
  this.confData.getMap().then(mapData =&gt; {
    let mapEle = document.getElementById('map');

    let cdata = mapData.find(d =&gt; d.center);
    let map = new AMap.Map(mapEle, {
      center: [cdata.lng,cdata.lat],
      zoom: 16
    });

    mapData.forEach(markerData =&gt; {
            let infoWindow = new AMap.InfoWindow({
                    content: `&lt;h1&gt;标记位置:&lt;/h1&gt;&lt;p&gt;${markerData.name}。&lt;/p&gt;`,
                    offset: new AMap.Pixel(0, -30),
                    size:new AMap.Size(230,0)
            });

            let marker = new AMap.Marker({
                    position: [markerData.lng,markerData.lat],
                    map: map,
                    title: markerData.name
            });

            let clickHandle = AMap.event.addListener(marker,'click', () =&gt; {
                    infoWindow.open(map, marker.getPosition());
            });
    });

    AMap.event.addListenerOnce(map, 'idle', () =&gt; {
            mapEle.classList.add('show-map');
    });
  });
</code></pre>

  </section>
</article>

	
	<div id="disqus_thread"></div>
<script type="text/javascript">
     
    var disqus_shortname = 'ryn';
    
     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	
</main>


</div>

<footer>
  <div class="container">
    <span class="copyright">&copy; 2016  刘雨飏@ANAS联盟 - <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
  </div>
</footer>

</body>
</html>

